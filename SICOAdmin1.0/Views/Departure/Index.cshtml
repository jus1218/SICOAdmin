@model SICOAdmin1._0.Models.Departure.Departure
@{
    ViewBag.Title = "Partida";
    var lstDeparture = (List<SICOAdmin1._0.Models.Departure.Departure>)ViewBag.lstDepartures;

}


<style>
    .th {
        text-align: center;
    }
</style>


<div class="container margin-container p-4 glass" id="renderLocalDeparture">
    @Html.Partial("_ShowDepartures", lstDeparture);
</div>

<!--VISTAS PARCIALES-->
@Html.Partial("_FormDeparture");

@Html.Partial("_DepartureLog");


<script>

    //========================= FORMULARIOS ================================

    let formDeparture = document.getElementById("formCrearDeparture");

    //========================= ELEMENTOS DEl MODAL ===========================

    let modalTitle = document.querySelector('#ModalTitle');
    let idDeparture = document.getElementById("IdPartida");
    let alias = document.getElementById("addAlias");
    let description = document.getElementById("addDescription");
    let active = document.getElementById("addActive");
    let typeDep = document.getElementById("addType");

    //========================= ELEMENTOS BITACORA ==============================


    const tbId = document.getElementById("tbIdDeparture");
    const tbUsuarioCreacion = document.getElementById("tbUsuarioCreacion");
    const tbUsuarioModificacion = document.getElementById("tbUsuarioModificacion")

    const tbFechaCreacion = document.getElementById("tbFechaCreacion");
    const tbFechaModificacion = document.getElementById("tbFechaModificacion");


    //====== BOTONES =======

    let btnModal = document.getElementById("btnModal");
    let btnAgregarDeparture = document.getElementById("btnAgregar");
    let btnEditarDeparture = document.getElementById("btnEditar");




    function jsChangeStatus(pId, pValue) {
        @*//@ViewBag.active = pValue;*@
        fetch("@Url.Content("~/Departure/ModificarEstadoDeparture")", {

           method: "POST",
           body: JSON.stringify({

               IdPartida: pId,
               Active: pValue,

                }),
            headers: {
                "Accept": "application/json",
                "Content-Type": "application/json"
            }

        }).then(res => res.ok ? res.json() : null)
            .then(res => {
                console.log(pValue);
                console.log(res);
                if (res.resp == 1) {
                    swal({
                        title: "Correcto", text: res.msj, type: "success", timer: 3000,
                        showConfirmButton: false
                    }
                    );
                } else {
                    swal({
                        title: "Ups... Ha ocurrido un error",
                        text: res.msj,
                        type: "error",
                        timer: 3000,
                        showConfirmButton: false
                    });
                }
                cargarComponenteDeparture();
            })




    }

    //========================= FUNCIONES FETCH===========================

    @*

    function editarDeparture() {
        console.log('Editar');
        $("#ModalDeparture").modal("hide");
        fetch("@Url.Content("~/Departure/EditarDeparture")" , {
            method: "POST",
            body: JSON.stringify({
                IdPartida: idDeparture.value,
                Description: description.value,
                Alias: alias.value,
                TypeDep: typeDep.value,
                Active: active.value

            }),
            headers: {
                "Accept": "application/json",
                "Content-Type": "application/json"
            }

        }).then(res => res.ok ? res.json() : null)
            .then(res => {
                console.log(res);
                if (res.resp = 1) {

                    swal('Bien!',
                        res.msj,
                        'success')
                } else {
                    console.log("error agregar");
                    swal('Opps!',
                        res.msj,
                        'error'
                    )
                }
            }).catch(res => console.log("Algo paso"))
        cargarComponenteDeparture();
    }*@

    function showaDataDeparture(pId,pAccion) {


       fetch("@Url.Content("~/Departure/ShowDataDeparture")" + "?pId=" + pId)

         .then(res => res.ok ? res.json() : null)
         .then(res => {
             console.log(res);

             if (pAccion == "Datos") {

                 idDeparture.textContent = res.IdPartida;
                 idDeparture.value = res.IdPartida;

                    alias.textContent = res.Alias;
                    alias.value = res.Alias;

                    description.textContent = res.Description;
                    description.value = res.Description;

                    //typeDep.textContent = res.TypeDep;
                    //typeDep.value = res.TypeDep;

                 if (res.TypeDep == "SL") {
                     typeDep.options.item(2).selected = 'selected';
                 } else {
                     typeDep.options.item(1).selected = 'selected';
                 }
                    if (res.Active) {
                        active.options.item(1).selected = 'selected';
                    } else {
                        active.options.item(2).selected = 'selected';
                    }

             } else {

                 tbId.textContent = res.IdPartida;
                 tbId.value = res.IdPartida;

                tbUsuarioCreacion.textContent = res.UserCreation;
                tbUsuarioCreacion.value = res.UserCreation;

                tbUsuarioModificacion.textContent = res.UserModification;
                tbUsuarioModificacion.value = res.UserModification;

                tbFechaCreacion.textContent = res.CreationDate;
                tbFechaCreacion.value = res.CreationDate;

                tbFechaModificacion.textContent = res.ModificationDate;
                tbFechaModificacion.value = res.ModificationDate;

                 $("#DepartureLog").modal("show");
             }

        })
    }


    //==========================================================================

    const d = document,
        $renderBody = d.getElementById("renderBody"),
        $formCreate = d.getElementById("formCrearDeparture");


    //CLICK
    $renderBody.addEventListener("click", (e) => {


        let page = e.target.dataset.value || "";


        if (e.target.id === "btnAgregar") {
            console.log("Entra al metodo llamar modal");
            formDeparture.reset();

            btnModal.value = "Agregar Partida";
            modalTitle.textContent = "Agregar Partida";

            $("#ModalDeparture").modal("show");
            return false;
        }
        else if (e.target.id === "btnEditar") {

            let idPartida = e.target.dataset.id;
            console.log(idPartida);

            modalTitle.textContent = "Editar Partida";
            btnModal.value = "Editar Partida";
            showaDataDeparture(idPartida, "Datos");
            $("#ModalDeparture").modal("show");

            return false;
        } else if (e.target.name === "nextPage") {

             siguientePagina({
                    sig: page,
                    totalPage: d.getElementById("totalPag").textContent,
                    CantRegistros: d.getElementById("tamanoPagina").value,
                    url: "@Url.Content("~/Departure/_TableDeparture")",
                 container: "tableDeparture",
                    palabraBuscar: d.getElementById("buscar").value.toLowerCase()
                })

            return false;
        }  else if (e.target.name === "previousPage") {
                retrocederPagina({
                   ant: page,
                   totalPage: d.getElementById("totalPag").textContent,
                   tamanoPagina: d.getElementById("tamanoPagina").value,
                   url: "@Url.Content("~/Departure/_TableDeparture")",
                    container: "tableDeparture",
                   palabraBuscar: d.getElementById("buscar").value.toLowerCase()
               })
            }


    })


    //SUBMIT
    $renderBody.addEventListener("submit", (e) => {
        e.preventDefault();

        if (e.target.id === "formCrearDeparture") {
            if (btnModal.value == "Agregar Partida") {

                $("#ModalDeparture").modal("hide");
                fetchMethod({

                    url: "@Url.Content("~/Departure/AgregarDeparture")",
                    body: {
                        Description: d.getElementById("addDescription").value,
                        Alias: d.getElementById("addAlias").value,
                        TypeDep: d.getElementById("addType").value,
                        Active: d.getElementById("addActive").value,

                    },
                    cbSuccess: (res) => {
                        if (res.resp == 1) {
                            console.log(res.mensaje);
                            cargarComponent({
                                container: "renderLocalDeparture",
                                url: "@Url.Content("~/Departure/_ShowDepartures")",
                            })
                                swal('Bien!',
                                res.msj,
                                'success')
                        }
                        else {
                            swal('Opps!',
                            res.msj,
                            'error')
                        }
                    }
                })
                return false;

            } else {

                $("#ModalDeparture").modal("hide");
                  fetchMethod({
                    url: "@Url.Content("~/Departure/EditarDeparture")",
                    body: {

                        IdPartida: d.getElementById("IdPartida").value,
                        Description: d.getElementById("addDescription").value,
                        Alias: d.getElementById("addAlias").value,
                        TypeDep: d.getElementById("addType").value,
                        Active: d.getElementById("addActive").value,
                    },
                    cbSuccess: (res) => {
                        if (res.resp == 1) {

                            cargarComponent({
                                container: "renderLocalDeparture",
                                url: "@Url.Content("~/Departure/_ShowDepartures")",
                            })
                                swal('Bien!',
                                res.msj,
                                'success')
                        }
                        else {
                            swal('Opps!',
                            res.msj,
                            'error')
                        }
                    }
                     })
                return false;
            }
            return false;
        }

    })


    //CHANGE
    $renderBody.addEventListener("change", (e) => {

        if (e.target.name === "stateDeparture") {

            let pId = e.target.dataset.id;
           
            fetchMethod({
                url: "@Url.Content("~/Departure/ModificarEstadoDeparture")?pId=" + pId,
                cbSuccess: (res) => {
                    if (res.resp == 1) {
                        cargarComponent({
                            container: "tableDeparture",
                            url: "@Url.Content("~/Departure/_TableDeparture")",
                            body: {
                                totalPaginas: d.getElementById("totalPag").textContent,
                                CantRegistros: d.getElementById("tamanoPagina").value,
                                palabraBuscar: d.getElementById("buscar").value.toLowerCase(),
                                NumPagina: (d.getElementById("pagActual").textContent - 1),
                            }
                        })
                        swal('Bien!',
                            res.msj,
                            'success')
                    }
                    else {
                        swal('Opps!',
                            res.msj,
                            'error')
                    }
                }
            });

            return false;
        }

            if (e.target.id === "tamanoPagina") {

                cambioTamanoPagina({
                    totalPage: d.getElementById("totalPag").textContent,
                    tamanoPagina: e.target.value,
                    url: "@Url.Content("~/Departure/_TableDeparture")",
                    container: "tableDeparture",
                    palabraBuscar: d.getElementById("buscar").value.toLowerCase(),
                    NumPagina: (d.getElementById("pagActual").textContent - 1)
                });
                return false;
            }
    })

      //KEY_UP
        $renderBody.addEventListener("keyup", (e) => {
            if (e.target.id === "buscar" ) {
                let palabraBuscar = e.target.value;
                //console.log(palabraBuscar.toLowerCase());
                buscarPalabra({
                    url: "@Url.Content("~/Departure/_TableDeparture")",
                    container: "tableDeparture",
                    palabraBuscar: d.getElementById("buscar").value.toLowerCase(),
                    tamanoPagina: d.getElementById("tamanoPagina").value
                });
                return false;
            }
        })

</script>
